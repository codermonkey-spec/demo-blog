# react工作原理

### 一.react 工作原理

我们从下面最简单的计数器的例子入手

```tsx
import React, { useState } from "react";

export default function Index() {
  const [counter, setCounter] = useState(0);

  return <p onClick={() => setCounter(counter + 1)}>{counter}</p>;
}
```

react是如何工作的呢?

### 预备知识

1.react采用的是**双缓存的机制**(这种**在内存中构建并直接替换**的技术叫做**[双缓存](https://baike.baidu.com/item/%E5%8F%8C%E7%BC%93%E5%86%B2)**)

2.react在内存中创建两个fiber树，当前屏幕上显示内容对应的`Fiber树`称为`current Fiber树，`正在内存中构建的`Fiber树`称为`workInProgress Fiber树`。

3.`current Fiber树`中的`Fiber节点`被称为`current fiber`，`workInProgress Fiber树`中的`Fiber节点`被称为`workInProgress fiber`，他们通过`alternate`属性连接。

4.**fiberRootNode**只会创建一个，而**rootFiber**是可以创建多个的，比如我们在使用**portal**时就会又创建一个。

![workInProgressFiber.png](../img/workInProgressFiber.png)

### 注意点:

1.当**首屏渲染**的时候，**rootFiber指向的是null**（**这也是我们的很多DOM操作要放到useEffect中去的原因，因为react刚开始的时候并没有渲染出DOM节点**）

2.在页面挂载完成后(也可以说是react进行了一次commit之后)我们的rootFiber下才有对应的DOM节点。

![wipTreeFinish.png](../img/wipTreeFinish.png)

3.在我们点击p元素后，react又会进行commit（即我们进行更新的时候）

![wipTreeUpdate.png](../img/wipTreeUpdate.png)